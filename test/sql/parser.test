# name: test/sql/parser.test
# description: test parser extension functions
# group: [parser]

require poached

# =============================================================================
# SCALAR FUNCTIONS
# =============================================================================

# -----------------------------------------------------------------------------
# is_valid_sql(query) -> BOOLEAN
# -----------------------------------------------------------------------------

query I
SELECT is_valid_sql('SELECT 1')
----
true

query I
SELECT is_valid_sql('SELECT * FROM users')
----
true

query I
SELECT is_valid_sql('SELEC 1')
----
false

query I
SELECT is_valid_sql('SELECT * FROM')
----
false

# -----------------------------------------------------------------------------
# num_statements(query) -> BIGINT
# -----------------------------------------------------------------------------

query I
SELECT num_statements('SELECT 1')
----
1

query I
SELECT num_statements('SELECT 1; SELECT 2; SELECT 3')
----
3

query I
SELECT num_statements('SELECT 1; INSERT INTO t VALUES (1); DELETE FROM t')
----
3

query I
SELECT num_statements('INVALID SQL')
----
0

# -----------------------------------------------------------------------------
# sql_error_message(query) -> VARCHAR
# -----------------------------------------------------------------------------

query I
SELECT sql_error_message('SELECT 1') IS NULL
----
true

query I
SELECT sql_error_message('SELEC 1') LIKE '%syntax error%'
----
true

# -----------------------------------------------------------------------------
# is_keyword(identifier) -> BOOLEAN
# -----------------------------------------------------------------------------

query I
SELECT is_keyword('SELECT')
----
true

query I
SELECT is_keyword('select')
----
true

query I
SELECT is_keyword('FROM')
----
true

query I
SELECT is_keyword('mytable')
----
false

query I
SELECT is_keyword('foo')
----
false

# -----------------------------------------------------------------------------
# sql_strip_comments(query) -> VARCHAR
# -----------------------------------------------------------------------------

query I
SELECT length(sql_strip_comments('SELECT 1 -- comment'))
----
9

query T
SELECT sql_strip_comments('SELECT /* block */ 1')
----
SELECT  1

query T
SELECT sql_strip_comments('SELECT ''not--comment''')
----
SELECT 'not--comment'

# -----------------------------------------------------------------------------
# parse_table_names(query) -> VARCHAR[]
# -----------------------------------------------------------------------------

query T
SELECT parse_table_names('SELECT 1')
----
[]

query T
SELECT parse_table_names('SELECT * FROM users')
----
[users]

query T
SELECT list_sort(parse_table_names('SELECT * FROM users JOIN orders ON users.id = orders.user_id'))
----
[orders, users]

# -----------------------------------------------------------------------------
# parse_function_names(query) -> VARCHAR[]
# -----------------------------------------------------------------------------

query I
SELECT list_sort(parse_function_names('SELECT UPPER(''x''), LENGTH(''y'')'))
----
[length, upper]

query I
SELECT list_sort(parse_function_names('SELECT COUNT(*), SUM(1)'))
----
[count_star, sum]

query T
SELECT parse_function_names('SELECT 1')
----
[]

# -----------------------------------------------------------------------------
# parse_keyword_names() -> VARCHAR[]
# -----------------------------------------------------------------------------

query I
SELECT COUNT(*) > 50 FROM UNNEST(parse_keyword_names()) AS t(keyword)
----
true

query T
SELECT keyword FROM UNNEST(parse_keyword_names()) AS t(keyword) WHERE keyword = 'select'
----
select

# -----------------------------------------------------------------------------
# parse_column_names(query, stmt_index) -> VARCHAR[]
# -----------------------------------------------------------------------------

query T
SELECT parse_column_names('SELECT 1 AS num, ''hello'' AS str', 0)
----
[num, str]

query T
SELECT parse_column_names('SELECT a, b, c', 0)
----
[a, b, c]

# -----------------------------------------------------------------------------
# sql_parse_json(query) -> VARCHAR (JSON)
# -----------------------------------------------------------------------------

# Valid query returns error=false
query I
SELECT sql_parse_json('SELECT 1') LIKE '%"error":false%'
----
true

# Valid query contains statement type
query I
SELECT sql_parse_json('SELECT 1') LIKE '%"type":"SELECT"%'
----
true

# Invalid query returns error=true
query I
SELECT sql_parse_json('INVALID SQL') LIKE '%"error":true%'
----
true

# Invalid query includes error message
query I
SELECT sql_parse_json('INVALID SQL') LIKE '%syntax error%'
----
true

query I
SELECT parse_sql_json('SELECT 1') LIKE '%"error":false%'
----
true

# =============================================================================
# TABLE FUNCTIONS
# =============================================================================

# -----------------------------------------------------------------------------
# sql_keywords() -> table(keyword)
# -----------------------------------------------------------------------------

query I
SELECT COUNT(*) > 50 FROM sql_keywords()
----
true

query T
SELECT keyword FROM sql_keywords() WHERE keyword = 'select'
----
select

query T
SELECT keyword FROM sql_keywords() WHERE keyword = 'from'
----
from

query T
SELECT keyword FROM sql_keywords() WHERE keyword = 'where'
----
where

# -----------------------------------------------------------------------------
# parse_keywords() -> table(keyword)
# -----------------------------------------------------------------------------

query I
SELECT COUNT(*) > 50 FROM parse_keywords()
----
true

query T
SELECT keyword FROM parse_keywords() WHERE keyword = 'select'
----
select

# -----------------------------------------------------------------------------
# parse_statements(query) -> table(stmt_index, stmt_type, error, param_count)
# -----------------------------------------------------------------------------

query ITTI
SELECT * FROM parse_statements('SELECT 1')
----
0	SELECT	NULL	0

query IT
SELECT stmt_index, stmt_type FROM parse_statements('SELECT 1; SELECT 2') ORDER BY stmt_index
----
0	SELECT
1	SELECT

query T
SELECT stmt_type FROM parse_statements('CREATE TABLE t(x INT)')
----
CREATE

query T
SELECT stmt_type FROM parse_statements('SET memory_limit=''1GB''')
----
SET

query I
SELECT error IS NOT NULL FROM parse_statements('INVALID SQL')
----
true

# -----------------------------------------------------------------------------
# parse_columns(query, stmt_index) -> table(col_index, col_name)
# -----------------------------------------------------------------------------

query IT
SELECT * FROM parse_columns('SELECT 1 AS num, ''hello'' AS str', 0)
----
0	num
1	str

query IT
SELECT * FROM parse_columns('SELECT a, b, c', 0)
----
0	a
1	b
2	c

query IT
SELECT * FROM parse_columns('SELECT count(*) AS cnt, upper(name) AS uname', 0)
----
0	cnt
1	uname

# -----------------------------------------------------------------------------
# tokenize_sql(query) -> table(byte_position, category)
# -----------------------------------------------------------------------------

query IT
SELECT * FROM tokenize_sql('SELECT * FROM tbl')
----
0	KEYWORD
7	OPERATOR
9	KEYWORD
14	IDENTIFIER

query I
SELECT COUNT(*) FROM tokenize_sql('SELECT a, b, c FROM t WHERE x > 1')
----
12

query T
SELECT category FROM tokenize_sql('SELECT 123') WHERE byte_position = 7
----
NUMERIC_CONSTANT

query T
SELECT category FROM tokenize_sql('SELECT ''hello''') WHERE byte_position = 7
----
STRING_CONSTANT

# -----------------------------------------------------------------------------
# parse_tokens(query) -> table(byte_position, category)
# -----------------------------------------------------------------------------

query IT
SELECT * FROM parse_tokens('SELECT * FROM tbl')
----
0	KEYWORD
7	OPERATOR
9	KEYWORD
14	IDENTIFIER

# -----------------------------------------------------------------------------
# parse_tables(query) -> table(schema_name, table_name, context)
# -----------------------------------------------------------------------------

query I
SELECT COUNT(*) FROM parse_tables('SELECT 1')
----
0

query TTT
SELECT * FROM parse_tables('SELECT * FROM users')
----
NULL	users	FROM

query TT
SELECT table_name, context FROM parse_tables('SELECT * FROM users JOIN orders ON true') ORDER BY table_name
----
orders	JOIN
users	FROM

# -----------------------------------------------------------------------------
# parse_functions(query) -> table(function_name, function_type)
# -----------------------------------------------------------------------------

query TT
SELECT * FROM parse_functions('SELECT UPPER(''x'')') ORDER BY function_name
----
upper	scalar

query TT
SELECT * FROM parse_functions('SELECT COUNT(*)') ORDER BY function_name
----
count_star	aggregate

query I
SELECT COUNT(*) FROM parse_functions('SELECT 1')
----
0

# -----------------------------------------------------------------------------
# parse_where(query) -> table(column_name, operator, value)
# -----------------------------------------------------------------------------

query TT
SELECT operator, value FROM parse_where('SELECT 1 WHERE 1 > 0')
----
>	0

query TT
SELECT operator, value FROM parse_where('SELECT 1 WHERE 5 = 5 AND 10 < 20') ORDER BY value
----
<	20
=	5

query I
SELECT COUNT(*) FROM parse_where('SELECT 1')
----
0
